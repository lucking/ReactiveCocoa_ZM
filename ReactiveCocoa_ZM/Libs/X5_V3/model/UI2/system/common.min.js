/*! 
* X5 v3 (htttp://www.justep.com) 
* Copyright 2014 Justep, Inc.
* Licensed under Apache License, Version 2.0 (http://www.apache.org/licenses/LICENSE-2.0) 
*/

define("$model/UI2/system/lib/base/viewComponent",["require","$UI/system/resources/system.res","./component","./util","./message","./error","jquery","bind"],function(e){e("$UI/system/resources/system.res");var t=e("./component"),n=e("./util"),r=e("./message"),i=e("./error"),s=e("jquery"),o=e("bind"),u="bind-",a="bind-attr-",f="data-events",l="data-bind",c=["bind-click","bind-dbclick","bind-dblclick","bind-focus","bind-blur","bind-select","bind-mousedown","bind-mouseup","bind-mouseover","bind-mousemove","bind-mouseout","bind-mouseenter","bind-mouseleave","bind-keydown","bind-keyup","bind-keypress","bind-touchstart","bind-touchmove","bind-touchend","bind-abort","bind-error","bind-change","bind-reset","bind-resize","bind-submit"],h=t.extend({constructor:function(e){this.__eventOperation__={},this.__events={},this.callParent(e)},constructed:function(e){this.callParent();if(e&&e.templateNode)this._bind(e.templateNode);else{e=e||{};var n=this.buildTemplate(e);if(!!n){var r=s(n)[0];this._bind(r),this._processEvents(e),this._processComponentBind(e),this._processBind(r,e),e.parentNode&&t.addComponent(e.parentNode,this)}}},_getComponentBinds:function(){var e=this.getConfig()||{};return e.binds||{}},_processComponentBind:function(e){e=e||{};var n=s(this.domNode),r=n.attr(t.COMPONENT_ATTR_NAME);if(r){var i="component:{name:'"+r+"'",o=this._getComponentBinds();for(var u in o)e[u]&&(i&&(i+=","),i+=o[u]+":"+e[u]);i+="}";var a=n.attr(l);a&&(i=a+","+i),n.attr(l,i)}},_getEvents:function(){var e=this.getConfig()||{};return e.events||[]},_processEvents:function(e){if(!e)return;var t=this._getEvents();if(n.isArray(t))for(var r=0;r<t.length;r++)e[t[r]]&&(this.__events[t[r]]=e[t[r]])},_getStandardBinds:function(e,t){var n={},r=s(e),i=e.attributes;for(var o=0;o<i.length;o++){var a=i[o].name,f=i[o].value;a.indexOf(u)===0&&(n[a]=f,r.removeAttr())}t=t||{};var l=(this.getConfig()||{}).binds||{};for(var c in t)c.indexOf(u)===0&&!(c in l)&&(n[c]=t[c]);return n},_processEventValue:function(e){return e&&e.indexOf(".")==-1&&e.indexOf("(")==-1?"$model._callModelFn.bind($model, '"+e+"')":e},_processBind:function(e,t){if(e.nodeType!=1)return;var n=s(e),r="",i="",o="",f="",h=this._getStandardBinds(e,t);for(var p in h){var d=h[p];c.indexOf(p)!=-1?(r=p.substring(u.length),f&&(f+=","),f+=r+":"+this._processEventValue(d)):p.indexOf(a)===0?(r=p.substring(a.length),o&&(o+=","),o+=r+":"+d):(r=p.substring(u.length),i&&(i+=","),i+=r+":"+d)}o&&(i&&(i+=","),i+="attr:{"+o+"}"),f&&(i&&(i+=","),i+="event:{"+f+"}");if(i){var v=n.attr(l);v&&(i=v+","+i),n.attr(l,i)}var m=n.children();for(var g=0;g<m.length;g++)this._processBind(m[g])},setCSS:function(e){this.$domNode.css(e)},addClass:function(e){this.$domNode.addClass(e)},toggleClass:function(e){this.$domNode.toggleClass(e)},removeClass:function(e){this.$domNode.removeClass(e)},fireEvent:function(e,t){return t&&this.domNode&&!t.hasOwnProperty("bindingContext")&&(t.bindingContext=o.contextFor(this.domNode)),this.callParent(e,t)},dispose:function(){this.domNode&&(this.getModel()._disposeComponent(this.domNode),o.utils.domData.set(this.domNode,t.BIND_NAME,null),this.domNode=null,this.$domNode=null),this.callParent()},inited:function(){this.getModel().resolvedComponent(this.domNode)},buildTemplate:function(e){},init:function(e,t){var n=this.$domNode.data("config");n&&this.set(n);var o=this.getModel(),u=s(this.domNode).attr(f);if(typeof u=="string"){var a=u.split(";");for(var l=0;l<a.length;l++){var c=a[l];if(c!==""){var h=c.indexOf(":");if(h==-1){var v=new r(r.JUSTEP230065,u);throw i.create(v)}var p=c.substring(0,h),d=c.substring(h+1);this.on(p,d,o)}}}for(var m in this.__events)this.on(m,this.__events[m],o);delete this.__events},update:function(e,t){if(!e)return;var n={},r=null;for(r in e)n[r]=o.utils.unwrapObservable(e[r]);if(!this._oldValues){this._oldValues=n;return}for(r in n){var i=this._oldValues[r],s=n[r];if(s!==i){var u={name:r,value:s,oldValue:i,allValue:n,oldAllValue:this._oldValues,source:this};this.fireEvent(h.DATA_CHANGED,u),this._oldValues[r]=s}}this._oldValues=n},controlsDescendantBindings:function(){return!1},getComponentByCompID:function(e){var n=this.getElementByCompID(e);return t.getComponent(n)},getElementByCompID:function(e){return this._getElementByCompID(this.domNode,e)},_getElementByCompID:function(e,n){var r=s(e);if(e!==this.domNode&&r.attr(t.COMP_ID)===n)return e;if(!r.attr(t.COMPONENT_ATTR_NAME)){var i=r.children();for(var o=0;o<i.length;o++){var u=i[o],a=this._getElementByCompID(u,n);if(a)return a}}return null},_bind:function(e){o.utils.domData.set(e,t.BIND_NAME,this),this.domNode=e,this.$domNode=s(this.domNode),o.utils.domNodeDisposal.addDisposeCallback(e,this.dispose.bind(this))}});return h.DATA_CHANGED="onDataChanged",h}),define("$model/UI2/system/lib/base/modelComponent",["require","./component"],function(e){var t=e("./component"),n=t.extend({});return n}),define("$model/UI2/system/lib/base/bindComponent",["require","bind","./viewComponent"],function(e){var t=e("bind"),n=e("./viewComponent"),r=n.extend({doInit:function(e,t,n){},render:function(){this.needRender=!1},dispose:function(){this._subscribeReadOnlyHandle&&this._subscribeReadOnlyHandle.dispose(),this._subscribeValidationHandle&&this._subscribeValidationHandle.dispose(),this.$domNode.remove(),this.callParent()},val2ref:function(){if(t.isObservable(this.ref)){var e="function"!=typeof this.val?this.get("value"):this.val();this._val2ref(this.ref,e)}},_val2ref:function(e,n){t.isObservable(e)&&e.set(n)},init:function(e,t,n){this.callParent(e,t,n);var r=this.ref;this.ref=e?e.ref:null;var i=this.doInit(e,t,n);return this.doUpdate(e,t,n),r!==this.ref&&(this._subscribeReadOnly(this.ref),this._subscribeValidation(this.ref)),this._inited=!0,this.render(),i},update:function(e,t,n){var r=this.ref;this.ref=e?e.ref:null,this.doUpdate(e,t,n),r!==this.ref&&(this._subscribeReadOnly(this.ref),this._subscribeValidation(this.ref)),this.callParent(e,t,n)},doUpdate:function(e,t,n){e&&e.hasOwnProperty("ref")&&(this.updateValue(e.ref),this.updateReadonly(e.ref),this.updateValidation(e.ref))},_subscribeReadOnly:function(e){this._subscribeReadOnlyHandle&&this._subscribeReadOnlyHandle.dispose();if(t.isObservable(e)&&e.readonly&&t.isObservable(e.readonly.computed)){var n=this;this._subscribeReadOnlyHandle=e.readonly.computed.subscribe(function(){n.updateReadonly(e)})}},_subscribeValidation:function(e){this._subscribeValidationHandle&&this._subscribeValidationHandle.dispose();if(t.isObservable(e)&&t.isObservable(e.isValid)){var n=this;this._subscribeValidationHandle=e.isValid.subscribe(function(){n.updateValidation(e)})}},updateValue:function(e){var n=t.isObservable(e)?e.get():null;"function"!=typeof this.val?this.set({value:n}):this.val(n)},updateValidation:function(e){if(!t.isObservable(e)||!e.isValid||!e.isModified)return;var n=e.isModified.get(),r=e.isValid.get(),i=(n?!r:!1)?"addClass":"removeClass";this.$domNode[i]("has-error");var s=this.$domNode.attr("data-orig-title");null===s&&(s=this.$domNode.attr("title")),this.$domNode.attr("title",r?s:e.error.get()).attr("data-orig-title",r?null:s)},updateReadonly:function(e){if(t.isObservable(e)&&e.readonly&&"function"==typeof e.readonly.readonlyFN){e.readonly.used||(e.readonly.computed=t.computed(function(){var t=e.readonly.readonlyFN;return t.call(e.readonly.ctx.caller,e.readonly.readonlyDef,e.readonly.ctx)}),e.readonly.used=!0);var n=e.readonly.computed.get();this.set({disabled:n})}},propertyChangedHandler:function(e,t,n){this.$domNode&&this.$domNode.attr(e,n)},set:function(e){e&&(this.callParent(e),this.needRender&&this.render())}});return r}),define("$model/UI2/system/components/justep/data/js/rules",["require","$UI/system/lib/justep","$UI/system/lib/base/express","$UI/system/lib/bind/bind.validation"],function(e){function s(e,t,r){return r.$val=e,"string"==typeof t.expr&&(t.expr=new n(t.expr)),t.expr instanceof n?n.eval(t.expr,r.$row,r):!0}function o(e){return e.$data.label(e.$col)}function u(e,t,n){return r.utils.isEmptyVal(e)||t.test(e.toString())}var t=e("$UI/system/lib/justep"),n=e("$UI/system/lib/base/express");e("$UI/system/lib/bind/bind.validation");var r=t.Bind.validation,i={add:function(e,t){r.rules[e]=t,r.registerExtenders()},remove:function(e){delete r.rules[e]},isExist:function(e){return!!r.rules[e]},each:function(e){if("function"==typeof e){var t=r.rules;for(var n in t)e(n,t[n])}}};return r.rules.constraint={validator:s,message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231600,r,e.expr.expr)).getMessage()}},r.rules.required={validator:function(e,t,n){var r=/^\s+|\s+$/g,i;if(e===undefined||e===null)return!t;var o=t.expr?s(e,t,n):t;return o?(i=e,typeof e=="string"&&(i=e.replace(r,"")),(i+"").length>0):!o},message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231601,r)).getMessage()}},r.rules.pattern={validator:u,message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231602,r,e)).getMessage()}},r.rules.email={validator:function(e,t,n){return t?r.utils.isEmptyVal(e)||t&&/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i.test(e):!0},message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231603,r)).getMessage()}},r.rules.datetime={validator:function(e,t,n){return t?u(e,/^([12][0-9]{3})-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])T([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9](\.[0-9]+)?(Z|[+-]([01][0-9]|2[0-3]):[0-5][0-9])?$/,n):!0},message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231604,r)).getMessage()}},r.rules.date={validator:function(e,t,n){return t?u(e,/^([12][0-9]{3})-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])(Z|[+-]([01][0-9]|2[0-3]):[0-5][0-9])?$/,n):!0},message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231605,r)).getMessage()}},r.rules.time={validator:function(e,t,n){return t?u(e,/^([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9](\.[0-9]+)?(Z|[+-]([01][0-9]|2[0-3]):[0-5][0-9])?$/,n):!0},message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231606,r)).getMessage()}},r.rules.number={validator:function(e,t,n){return t?r.utils.isEmptyVal(e)||t&&/^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$/.test(e):!0},message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231607,r)).getMessage()}},r.rules.integer={validator:function(e,t,n){return t?r.utils.isEmptyVal(e)||t&&/^\d+$/.test(e):!0},message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231608,r)).getMessage()}},r.registerExtenders(),i}),define("$model/UI2/system/components/justep/data/data",["require","jquery","$UI/system/lib/justep","./js/rules","$UI/system/lib/bind/bind.validation","$UI/system/resources/system.res"],function(require){var $=require("jquery"),justep=require("$UI/system/lib/justep"),Bind=justep.Bind,Model=justep.ModelBase,Expr=justep.Express,Rules=require("./js/rules");require("$UI/system/lib/bind/bind.validation"),require("$UI/system/resources/system.res");var Row=justep.Object.extend({constructor:function(e,t){this.data=e,this.row=t},ref:function(e){var t=this.row[e];return t?t.value:undefined},val:function(e,t){if(arguments.length==1)return this.data.getValue(e,this);this.data.setValue(e,t,this)},label:function(e){return this.data.label(e)},parent:function(){return this.row.userdata?this.row.userdata.parent:undefined},hasChildren:function(){return this.rows&&this.rows.get().length>0},getID:function(){return this.data.getRowID(this)}}),Data=justep.ModelComponent.extend({constructor:function(e,t){this.callParent(),this.clz=Data,this.autoLoad=!1,this.autoNew=!1,this.isMainData=!1,this.delim=",",this.versionRelation="version",this.updateMode="whereVersion",this.distinct=null,this.defTreeOption={isTree:!1},this.orderBys={},this.userdata={},this.directDeleteMode=!1,this.confirmDelete=!0,this.confirmDeleteText=justep.Message.getMessage(justep.Message.JUSTEP231000),this.confirmRefresh=!0,this.confirmRefreshText=justep.Message.getMessage(justep.Message.JUSTEP231001),this.offset=0,this.limit=20,this.dataType="json",this.xid=t?t.xid:"",this.currentRow=Bind.observable(),this.datas=this.allDatas=Bind.observableArray(),this.allDatas.owner=this,this.setTotal(0),this.deleteDatas=Bind.observableArray(),this.slaveDatas=[],this.isModified=Bind.observable(!1),this.isChanged=function(){return this.isSelfChanged()||this.isSlaveChanged()},this._init(e,t)},_getSelfValid:function(){var e=!0;return this.eachAll(function(t){var n=t.row,r=n.row.userdata.recordState;if(Data.STATE.NEW==r||Data.STATE.EDIT==r)for(var i in t.data.defCols){var s=n.ref(i);if(s&&Bind.isObservable(s.isValid)&&!s.isValid.get()){e=!1,t.cancel=!0;break}}}),e},_getSelfInvalidInfo:function(){var e=[];return this.eachAll(function(t){var n=t.row,r=n.row.userdata.recordState;if(Data.STATE.NEW==r||Data.STATE.EDIT==r)for(var i in t.data.defCols){var s=n.ref(i);if(s&&Bind.isObservable(s.error)){var o=s.error.get();o&&e.push(o)}}}),e.join(";")},getReadonly:function(e,t){if(!e||!t)return this.readonly.get();var n=t.ref(e);if(n&&n.readonly&&n.readonly.used)return n.readonly.computed.get();this.readonly.get()},clone:function(e){var t=$.extend({},this.definition);return t.xid=e||Data.UUID(),delete t.master,delete t.autoLoad,delete t.autoNew,new this.clz(this.getModel(),t)},_dispose:function(e){if(Bind.isObservable(e))e.extend({validatable:!1,readonly:!1}),e.getSubscriptionsCount()>0&&(e._subscriptions.change=[]);else if(Bind.isComputed(e))e.extend({validatable:!1,readonly:!1}),e.target&&(this._dispose(e.target),delete e.target),e.dispose();else if(Bind.validation.utils.isObservableArray(e)){var t=e.get(),n=0;for(;n<t.length;n++){var r=t[n].row;r.userdata&&r.userdata.isModified&&this._dispose(r.userdata.isModified);for(var i in this.defCols)this._dispose(r.ref(i))}e.destroyAll()}},dispose:function(){Data.unRegisterData(this.getModel(),this.xid),this._dispose(this.readonly),this._dispose(this.index),this._dispose(this.indexParent),this._dispose(this.currentRow),this._dispose(this.isModified),this._dispose(this.allDatas),this._dispose(this.deleteDatas),delete this.readonly,delete this.index,delete this.indexParent,delete this.currentRow,delete this.isModified,delete this.allDatas,delete this.deleteDatas},createErrorValue:function(e){return Data.createErrorValue(e)},getContext:function(){return this.getModel().getContext()},getProcess:function(){return this.process||this.getContext().getProcess()},getActivity:function(){return this.activity||this.getContext().getActivity()},label:function(e){var t=this.defCols[e];return t?t.label:""},_setLoaded:function(e,t){t?(t.row.userdata||(t.row.userdate={}),t.row.userdata._loaded=e):this.loaded=e},open:function(){this.isLoaded()||this.refreshData()},isLoaded:function(e){return!e||this.defTreeOption.isTree&&!this.defTreeOption.option.isDelayLoad?this.loaded:e.row.userdata&&e.row.userdata._loaded?e.row.userdata._loaded:!1},hasMore:function(e){if(this.limit==-1)return!1;var t=e?e.rows?e.rows.get():[]:this.datas.get();return this.getTotal(e)>t.length},getTotal:function(e){return e?e.row.userdata&&e.row.userdata._total?e.row.userdata._total.get():0:this.total.get()},setTotal:function(e,t){t?(t.row.userdata||(t.row.userdata={}),t.row.userdata._total||(t.row.userdata._total=Bind.observable()),t.row.userdata._total.set(e)):(this.total||(this.total=Bind.observable()),this.total.set(e))},getOffset:function(e){return e?e.row.userdata&&e.row.userdata._offset?e.row.userdata._offset:0:this.offset},setOffset:function(e,t){t?(t.row.userdata||(t.row.userdata={}),t.row.userdata._offset=e):this.offset=e},ref:function(e,t){return this._inited?(typeof t!="object"&&(t=this.currentRow.get()),t?t.ref(e):""):""},val:function(e,t){return this.getValue(e,t)},eachAll:function(e,t,n){if("function"!=typeof e)return;var r=n?Bind.isObservable(n.rows)?n.rows.get():[]:this.allDatas.get(),i=r.length;for(var s=0;s<i;s++){var o={index:s,row:r[s],cancel:!1,parent:n,data:this};e.call(t||o.row,o);if(o.cancel)return;if(Bind.isObservable(o.row.rows)&&!this.eachAll(e,t,o.row))return}return!0},each:function(e,t,n){this.eachAll(e,t,n?n:{rows:this.datas})},getChildren:function(e){return e?Bind.isObservable(e.rows)?e.rows.get():[]:this.datas.get()},isSelfChanged:function(){var e=!1;return this.eachAll(function(t){var n=t.row.row.userdata.recordState;if(Data.STATE.NEW==n||Data.STATE.EDIT==n)e=!0,t.cancel=!0}),e||this.deleteDatas.get().length>0},isSlaveChanged:function(){var e=this.slaveDatas.length;for(var t=0;t<e;t++)if(this.slaveDatas[t].isChanged())return!0;return!1},_bindMaster:function(){this.master&&!this.master.masterData&&this.master.xid&&(this.master.masterData=Data.$(this.getModel(),this.master.xid),this.master.masterData&&(this.master.masterData.slaveDatas.push(this),this.byMaster={},this.datas=this.filterByMaster(),this.setTotal(0),this.master.masterData.currentRow.subscribe(function(e){if(undefined===e)return;var t=this.master.masterData.getRowID(e);this.byMaster[t]||(this.byMaster[t]={}),this.byMaster[t].current=this.currentRow.get(),this.byMaster[t].offset=this.getOffset()},this,"beforeChange")))},_createReadonly:function(){typeof this.definition.readonly=="string"&&(this.definition.readonly=new Expr(this.definition.readonly)),this.readonly=Bind.computed(function(){var e={$model:this.getModel(),$data:this};return this.definition.readonly instanceof Expr?Expr.eval(this.definition.readonly,this,e):this.definition.readonly},this)},_init:function(e,t){if(!e||!t)return;this.setModel(e),this.definition=t,this._createReadonly(),this._initDefinition(),this.attachEvents(t.events);var n=function(){this._bindMaster(),Data.registerData(e,this.xid,this);var t={source:this};this.fireEvent(Data.EVENT_CREATE,t),this.getModel().resolvedComponent(this.xid),this._inited=!0},r=this,i=function(e){r.autoNew&&!r.master?r.newData():r.autoLoad&&!r.master&&r.open()};e.isConctructed()?i():e.on(Model.MODEL_CONSTRUCTING_EVENT,i),!this.master||this.master.masterData||!this.master.xid?n.call(r):e.componentPromise(this.master.xid).then(function(){n.call(r)},function(e){var t=new justep.Message(justep.Message.JUSTEP231078,r.xid,e);throw justep.Error.create(t)})},_initDefinition:function(){this.process=this.definition.process||"",this.activity=this.definition.activity||"",this.dataModel=this.definition.dataModel||"",this.definition.autoLoad&&(this.autoLoad=!0),this.definition.autoNew&&(this.autoNew=!0),this.definition.limit&&(this.limit=this.definition.limit),this.definition.offset&&this.setOffset(this.definition.offset),this.definition.directDelete&&(this.directDeleteMode=this.definition.directDelete),this.definition.confirmDelete===!1&&(this.confirmDelete=!1),this.definition.confirmDeleteText&&(this.confirmDeleteText=this.definition.confirmDeleteText),this.definition.confirmRefresh===!1&&(this.confirmRefresh=!1),this.definition.confirmRefreshText&&(this.confirmRefreshText=this.definition.confirmRefreshText),this.definition.filterRelations&&(this.defFilterRelations=this.definition.filterRelations),this.definition.updateMode&&(this.updateMode=this.definition.updateMode),this.definition.orderBys&&(this.orderBys=this.definition.orderBys);var e=this.definition.filters;for(var t in e)this.setFilter(t,e[t]);this.concept=this.definition.concept,this.idColumn=this.definition.idColumn,this.defaultValues=this.definition.defaultValues,this._initDefCols(),this._initRules(),this.defAggCols=this.definition.defAggCols,this.master=this.definition.master,this.definition.treeOption?(this.defTreeOption.isTree=!0,this.defTreeOption.option=this.definition.treeOption):this.defTreeOption.option={}},getTreeOption:function(){return this.defTreeOption.option},_initDefCols:function(){this.defCols=this.definition.defCols},_initRules:function(){for(var e in this.defCols){var t=this.defCols[e].rules;if(t&&!Bind.validation.utils.isObservableArray(t)){var n=[];for(var r in t){if("readonly"==r||"calculate"==r){this.defCols[e][r]=t[r],delete t[r];continue}var i=t[r];i&&(i.message||i.onlyIf)?n.push({rule:r,message:i.message,params:Bind.validation.utils.isEmptyVal(i.params)?!0:i.params,condition:i.onlyIf}):n.push({rule:r,params:i})}n.length>0?this.defCols[e].rules=Bind.observableArray(n):delete this.defCols[e].rules}}},buildFilter:function(){return""},getFilter:function(e){return""},setFilter:function(e,t){return""},setOrderBy:function(e,t){null!==t&&undefined!==t?this.orderBys[e]=t:delete this.orderBys[e]},getOrderBy:function(e){return this.orderBys[e]},clearOrderBy:function(){this.orderBys={}},getOrderBys:function(){var e="";for(var t in this.orderBys)e+=(e!==""?",":"")+t+(0===this.orderBys[t]?" DESC":" ASC");return e},getResultRelations:function(){var e=null;for(var t in this.defCols)this.isUICalculateCol(t)||(e=null!==e?e+","+t:t);return e},getColumnIDs:function(){var e=null;for(var t in this.defCols)e=null!==e?e+","+t:t;return e},getAggRelations:function(){var e="";for(var t in this.defAggCols)e+=""!==e?","+t:t;return e},doDataChanged:function(e){var t={};this.hasListener(Data.EVENT_DATA_CHANGE)&&(justep.Util.apply(t,e),this.fireEvent(Data.EVENT_DATA_CHANGE,t));if(this.master&&this.master.masterData){var n=this.master.masterData;n&&(t=$.extend({},e),t.source=n,t.selfChanged=!1,n.doDataChanged(t))}},attachEvents:function(events){if(!events)return;typeof events=="string"&&(events=eval("("+events+")"));if(!events)return;for(var o in events){var func=events[o];if(typeof func=="string")with(this.getModel()||window)func=eval("("+func+")");typeof func=="function"&&this.on(o,func,this.getModel())}},_clear:function(e){(!e||this.isChild(this.getCurrentRow(),e))&&this.currentRow.set();var t,n=null;if(!e){t=this.allDatas.get();for(n in t)this._clear(t[n]);this.allDatas.removeAll(),this.deleteDatas.removeAll()}else{if(e.rows){t=e.rows.get();for(n in t)this._clear(t[n]);e.rows.removeAll()}var r=this.deleteDatas.get();for(var i=0;i<r.length;i++)this.isChild(r[i],e)&&this.deleteDatas.splice(i,1)}},isChild:function(e,t){if(!e)return!1;var n=e.parent();return n===t?!0:n?this.isChild(n,t):!1},clear:function(e){this._clear(e);var t={};t.source=this,t.changedSource=this,t.type="clear",t.selfChanged=!0,t.parent=e,this.doDataChanged(t)},_reloadDefByUserData:function(e,t){t||justep.Util.apply(this.userdata,e),typeof e=="object"&&(e.hasOwnProperty("sys.loaded")&&this._setLoaded(e["sys.loaded"],t),e.hasOwnProperty("sys.count")&&this.setTotal(e["sys.count"],t),e.hasOwnProperty("sys.offset")&&this.setOffset(e["sys.offset"],t))},loadData:function(e,t,n,r){r=undefined===r?-1:r;var i=[];if(e&&("table"==e["@type"]||$.isArray(e.rows))){t||this._clear(n),this._reloadDefByUserData(e.userdata,n);var s=e.rows?e.rows:[],o=[];for(var u=0;u<s.length;u++){var a=s[u];a.userdata&&a.userdata.id&&(a[this.idColumn]=a.userdata.id,delete a.userdata.id);var f=this.add(a,n,!0,!0);o.push(f),i.push(f),a.rows&&i.push(i,this.loadData(a,t,f))}n?n.rows?-1==r?n.rows.push.apply(n.rows,o):n.rows.splice.apply(n.rows,[r,0].concat(o)):n.rows=Bind.observableArray(o):-1==r?this.allDatas.push.apply(this.allDatas,o):this.allDatas.splice.apply(this.allDatas,[r,0].concat(o))}return i},isExist:function(e){var t=!1;return this.each(function(n){e==this.getRowID(n.row)&&(n.cancel=!0,t=!0)},this),t},getUserData:function(e,t){return t?t.row.userdata[e]:this.userdata[e]},setUserData:function(e,t,n){var r=n?n.row.userdata:this.userdata;r[e]=t},find:function(e,t,n,r,i,s){var o=[],u=0;t&&e&&(u=t.length>e.length?e.length:t.length);if(u>0){var a=s?"eachAll":"each";this[a](function(s){var a=!0,f=s.row;for(var l=0;l<u;l++){var c=this.getValue(e[l],f);if(typeof c=="string"){c=r?c.toLowerCase():c;var h=r?(t[l]+"").toLowerCase():t[l];a=a&&(i?c.indexOf(h)!=-1:c==h)}else a=t[l]===c;if(!a)break}if(a){o.push(f);if(n)return o}},this)}return o},isValid:function(){return this._getSelfValid()&&function(){for(var e=0;e<this.slaveDatas.length;e++)if(!this.slaveDatas[e].isValid())return!1;return!0}.call(this)},getInvalidInfo:function(){var e="";for(var t=0;t<this.slaveDatas.length;t++)e+=this.slaveDatas[t]._getSelfInvalidInfo()+"\n";return this._getSelfInvalidInfo()+"\n"+e},convert:function(e,t){return Data.convert(e,t)},filterByMaster:function(){if(!this.master)return this.allDatas;var e=Bind.computed(function(){var e=this.master.masterData,t=e.currentRow.get(),n=e.getRowID(t);if(undefined===t)return[];var r=this.byMaster[n];if(!r||!r.loaded){var i={source:this,loaded:Data.STATE.NEW===e.getRowState(e.currentRow.get())};this.fireEvent(Data.EVENT_LOAD_SLAVEDATA,i),!i.loaded&&this.autoLoad&&Data.STATE.NEW!==e.getRowState(e.currentRow.get())&&(i.loaded=this._refreshData({append:!0,offset:0})),r?r.loaded=i.loaded:this.byMaster[n]={loaded:i.loaded}}var s=this.allDatas.get(),o=[];for(var u=0;u<s.length;u++){var a=s[u];Bind.unwrap(a.ref(this.master.relation).get())===n&&o.push(a)}return r&&r.loaded?(this.currentRow.set(r.current),this.setOffset(r.offset)):o.length>0&&this.currentRow.set(o[0]),o},this);return e.owner=this,e},bindRules:function(e,t,n,r){return t&&e.extend({validatable:{enable:!0,rules:t,isModified:n,ctx:r}}),e},_doReadonly:function(e,t){return this.readonly.get()||e instanceof Expr&&Expr.eval(e,t.$row,t)},bindReadonly:function(e,t,n){return n.caller=this,e.extend({readonly:{readonlyFN:this._doReadonly,readonlyDef:t,ctx:n}}),e},bindCalculate:function(e,t,n){var r=Bind.computed({read:function(){if(!this._inited)return"";var r=e.get(),i=Expr.eval(t,n.$row,n);return i!==r&&e.set(i),e.get()},write:function(t){e.set(t)}},this);return r.target=e,r},getParentRelation:function(){return this.defTreeOption.isTree?this.defTreeOption.option.parentRelation:""},bindValueChange:function(e,t){var n=Bind.observable(e);return n.subscribe(function(e){e.newValue!==e.oldValue&&(e.source=t.data,e.row=t.row,e.col=t.col,t.handler.call(t.caller,e))},null,"changing"),n.subscribe(function(e){var n={source:t.data,row:t.row,col:t.col,value:e};t.handler.call(t.caller,n,!0)}),n},disableRecordChange:function(){this._disableRecordChange=!0},enabledRecordChange:function(){this._disableRecordChange=!1},canRecordChange:function(){return!this._disableRecordChange},isCalculateCol:function(e){if(e){"string"==typeof e&&(e=this.defCols[e]);if("object"==typeof e)return"EXPRESS"===e.relation||"STATISTICAL"==e.relation}},isUICalculateCol:function(e){if(e){"string"==typeof e&&(e=this.defCols[e]);if("object"==typeof e)return!e.isBiz&&("EXPRESS"===e.relation||"STATISTICAL"==e.relation)}},_doValueChange:function(e,t){if(!this.canRecordChange())return;if(!t){this.fireEvent(Data.EVENT_VALUE_CHANGE,e);if(!this.isCalculateCol(e.col)&&e.oldValue!==e.newValue){var n=e.row;if(n){var r=n.row.userdata.recordState;if(r!==Data.STATE.NEW){var i=n.row[e.col];1!==i.changed&&(i.originalValue=e.oldValue,n.row.userdata.recordState=Data.STATE.EDIT,i.changed=1,n.row.userdata.isModified.set(!0),this.isModified.set(!0))}}}}else this.fireEvent(Data.EVENT_VALUE_CHANGED,e),e.changedSource=this,e.type="valueChanged",e.selfChanged=!0,this.doDataChanged(e);Data.debug&&console.log("行["+e.rowID+"]列["+e.col+"]changed,"+"old:"+e.oldValue+",newValue:"+e.newValue)},getRowByID:function(e,t){if(e!==undefined){var n=null,r=t?"eachAll":"each";return this[r](function(t){e==this.getRowID(t.row)&&(t.cancel=!0,n=t.row)},this),n}return this.currentRow.get()},getValue:function(e,t){t||(t=this.currentRow.get());var n=t?t.ref(e):undefined,r=this.defCols[e];return this.convert(Bind.isObservable(n)?n.get():n,r?r.type:"String")},setValue:function(e,t,n){n||(n=this.currentRow.get()),n.ref(e).set(t)},getValueByID:function(e,t){return this.getValue(e,this.getRowByID(t,!0))},setValueByID:function(e,t,n){this.setValue(e,t,this.getRowByID(n,!0))},getRowState:function(e){return e&&e.row.userdata&&e.row.userdata.recordState?e.row.userdata.recordState:Data.STATE.NONE},setRowState:function(e,t){e&&e.row.userdata&&(e.row.userdata.recordState=t)},getRowID:function(e){return e===undefined&&(e=this.getCurrentRow()),e?e.ref(this.idColumn).get():undefined},to:function(e){typeof e=="string"&&(e=this.getRowByID(e));if((e instanceof Data.Row||e===undefined||e===null)&&e!==this.getCurrentRow()){var t={source:this,row:e,originalRow:this.currentRow.get(),cancel:!1};this.fireEvent(Data.EVENT_INDEX_CHANGING,t);if(t.cancel)return;this.currentRow.set(e),this.fireEvent(Data.EVENT_INDEX_CHANGED,t)}},getCount:function(){if(!this.defTreeOption.isTree)return this.datas.get().length;var e=0;return this.each(function(){e++},this),e},next:function(){var e=this.currentRow.get(),t=!1;this.each(function(n){t&&(this.to(n.row),n.cancel=!0,t=!1),n.row==e&&(t=!0)},this)},pre:function(){var e=this.currentRow.get(),t=null;this.each(function(n){n.row==e&&(null!==t&&this.to(t),n.cancel=!0,t=null),t=n.row},this)},first:function(){this.to(this.getFirstRow())},last:function(){this.to(this.getLastRow())},getFirstRow:function(){var e=this.datas.get();return e.length>0?e[0]:null},getLastRow:function(){var e=this.datas.get();return e.length>0?this._lastRow(e):null},getCurrentRow:function(){return this.currentRow.get()},getCurrentRowID:function(){return this.getRowID(this.getCurrentRow())},_lastRow:function(e){var t=e.length,n=e[t-1];return t>0&&n.rows?this._lastRow(n.rows.get()):n},isLeaf:function(e){return this.defTreeOption.isTree&&e?e.row[this.defTreeOption.option.nodeKindRelation]?Data.NODE_KIND_LEAF==e.ref(this.defTreeOption.option.nodeKindRelation).get():!1:!0},isTree:function(){return this.defTreeOption&&this.defTreeOption.isTree},newData:function(e){var t=-1,n=null,r=null,i=null,s=null;arguments.length==1&&typeof e=="object"&&(t=e.hasOwnProperty("index")?e.index:t,n=e.parent,r=e.defaultValues,i=e.onSuccess,s=e.onError);var o={cancel:!1,option:e,source:this};this.fireEvent(Data.EVENT_NEWDATA_BEFORE,o);if(o.cancel)return null;var u=null;return this.hasListener(Data.EVENT_NEWDATA)?(o={data:u,option:e,source:this},this.fireEvent(Data.EVENT_NEWDATA,o),u=o.data):u=this.doNewData(r,e),u?(r=this.loadData(u,!0,n,t),o={rows:r,source:this},this.fireEvent(Data.EVENT_NEWDATA_AFTER,o),o.changedSource=this,o.type="new",o.selfChanged=!0,this.doDataChanged(o),this._setLoaded(!0,n),i&&$.isFunction(i)&&i({source:this,rows:r}),r.length>0&&this.to(r[0]),r):null},doNewData:function(e,t){if(!e||e.length<=0)e=[{}];var n={rows:[],userData:{},"@type":"table"};for(var r in e){var i=e[r];i.userdata||(i.userdata={}),i.userdata.recordState=Data.STATE.NEW,n.rows.push(i)}return n},_beginBatch:function(){return!0},_cancelBatch:function(){return!0},_endBatch:function(){return!0},saveData:function(e){var t=null,n=null,r=null,i=!0,s=!1;arguments.length==1&&typeof e=="object"&&(s=!!e.ignoreInvalid,undefined!==e.useTrans&&(i=!!e.useTrans),n=e.onSuccess,r=e.onError);var o=!1;if(!this.isChanged())return!0;if(!s&&!this.isValid())throw new Error(this.getInvalidInfo());if(!1!==i&&!this._beginBatch()){var u=new justep.Message(justep.Message.JUSTEP231019);throw justep.Error.create(u)}try{var a={cancel:!1,source:this};this.fireEvent(Data.EVENT_SAVEDATA_BEFORE,a);if(a.cancel)return!1!==i&&this._cancelBatch(),!1;this.hasListener(Data.EVENT_SAVEDATA)?(a={cancel:!1,source:this},this.fireEvent(Data.EVENT_SAVEDATA,a),o=!a.cancel):o=this.doSaveData(t,{onSuccess:n,onError:r});if(!o)return!1!==i&&this._cancelBatch(),!1;a={cancel:!1,source:this},this.fireEvent(Data.EVENT_SAVEDATA_AFTER,a);if(a.cancel)return!1!==i&&this._cancelBatch(),!1}catch(f){!1!==i&&this._cancelBatch();var u=new justep.Message(justep.Message.JUSTEP231020,f.message||f);throw justep.Error.create(u)}return!1!==i&&this._endBatch(),!0},doSaveData:function(e,t){return!0},applyUpdates:function(){this.disableRecordChange();try{var e=this.deleteDatas.get();e.splice(0,e.length),this.eachAll(function(e){var t=e.row.row;if(this.updateMode=="whereVersion"){var n=t.userdata.recordState;if(Data.STATE.EDIT==n){var r=this.getVersionColumn();if(r&&t[r]){var i=parseInt(t[r].value.get(),10)+1;t[r].value.set(i)}}}for(var s in this.defCols)t[s].changed=0,t[s].originalValue=t[s].value.get();t.userdata.recordState=Data.STATE.NONE},this)}finally{this.enabledRecordChange()}},getVersionColumn:function(){return this.versionRelation},loadNextPageData:function(e){if(this.limit==-1)return;return e=e||{append:!0},this.isLoaded()?this._refreshData(e):this.refreshData(e)},loadAllPageData:function(e){e=e||{};if(this.limit==-1&&!this.isLoaded())return this.refreshData(e);if(this.isLoaded())return;var t=this.getTotal(e.parent),n=this.getOffset(e.parent);if(t<=n)return;if(t<1)return;var r=this.limit;try{return e.append=!0,e.limit=t,this._refreshData(e)}finally{this.limit=r}},loadPageData:function(e,t){return this.limit==-1||1==e?this.refreshData(t):(t=t||{},e=e<1?1:e,t.offset=(e-1)*this.limit,t.append=!1,this._refreshData(t))},refreshData:function(e){return e=e||{},this.definition.offset?e.offset=this.definition.offset:e.offset=0,e.append=!1,this._refreshData(e)},_refreshData:function(e){var t=!1,n=this.getRowID(this.currentRow.get()),r={cancel:!1,options:e,source:this};this.fireEvent(Data.EVENT_REFRESHDATA_BEFORE,r);if(r.cancel)return!1;var i=e&&e.append||(this.isChanged()&&this.confirmRefresh?confirm(this.confirmRefreshText):!0);if(i){e&&"number"==typeof e.offset&&this.setOffset(e.offset,e.parent),e&&"number"==typeof e.limit&&(this.limit=e.limit),this.hasListener(Data.EVENT_REFRESHDATA)?(r={cancel:!1,limit:this.limit,offset:this.getOffset(e.parent),options:e,source:this},this.fireEvent(Data.EVENT_REFRESHDATA,r),t=!r.cancel):t=this.doRefreshData(e);if(t){this._setLoaded(!0,e?e.parent:null);if(!e||!e.append){var s=this.getRowByID(n);s?s&&this.to(s):this.first()}this.limit!=-1&&this.setOffset(this.getOffset(e?e.parent:null)+this.limit,e?e.parent:null)}}return r={limit:this.limit,offset:this.getOffset(e?e.parent:null),options:e,source:this,success:t},this.fireEvent(Data.EVENT_REFRESHDATA_AFTER,r),r.changedSource=this,r.type="refresh",r.selfChanged=!0,this.doDataChanged(r),t},doRefreshData:function(options){return this.definition.initData&&this.loadData({rows:eval("("+this.definition.initData+")"),"@type":"table"}),!0},deleteData:function(e,t){var n=!1;e=e?e:[this.currentRow.get()],e instanceof Data.Row&&(e=[e]);var r={cancel:!1,source:this,deleteRows:e};this.fireEvent(Data.EVENT_DELETEDATA_BEFORE,r);if(r.cancel)return!1;if(this.hasListener(Data.EVENT_DELETEDATA)){r={cancel:!1,source:this,deleteRows:e},this.fireEvent(Data.EVENT_DELETEDATA,r);if(r.cancel)return!1}else{var i=this.confirmDelete?confirm(this.confirmDeleteText):!0,s=0,o;if(!i)return!1;if(!this.directDeleteMode){if(!e)return!1;for(s=0;s<e.length;s++)o=e[s],Data.STATE.NEW!=this.getRowState(o)&&(this.setRowState(o,Data.STATE.DELETE),this.deleteDatas.push(o)),this.remove(o);n=!0}else{n=this.doDirectDeleteData(e);if(n)for(s=0;s<e.length;s++){o=e[s];var u=this.getTotal(o.row.userdata.parent)-1;this.setTotal(u>=0?u:0,o.row.userdata.parent),this.remove(o)}}}return r={source:this,deleteRows:e},this.fireEvent(Data.EVENT_DELETEDATA_AFTER,r),r.changedSource=this,r.type="delete",r.selfChanged=!0,this.doDataChanged(r),n},doDirectDeleteData:function(e){return!0},_bindValue:function(e,t,n){typeof e.row[t]!="object"&&(e.row[t]={changed:0,value:e.row[t],originalValue:null}),e.row[t].value=this.bindValueChange(e.row[t].value,{data:this,handler:this._doValueChange,caller:this,rowID:n,row:e,col:t})},_bindRule:function(e,t,n){var r=this.defCols[t];r.calculate&&(typeof r.calculate=="string"&&(r.calculate=new Expr(r.calculate)),r.calculate instanceof Expr&&(e.row[t].value=this.bindCalculate(e.row[t].value,r.calculate,{$model:this.getModel(),$data:this,$row:e,$rowID:n,$col:t}))),this.bindRules(e.row[t].value,r.rules,e.row.userdata.isModified,{$model:this.getModel(),$data:this,$row:e,$rowID:n,$col:t}),typeof r.readonly=="string"&&(r.readonly=new Expr(r.readonly)),this.bindReadonly(e.row[t].value,r.readonly,{$model:this.getModel(),$data:this,$row:e,$rowID:n,$col:t}),e.row[t].value.define={data:this,row:e,defCol:r}},add:function(e,t,n,r){e=e||{};for(var i in this.defCols)e[i]=e[i];this.master&&!e[this.master.relation]&&(e[this.master.relation]=this.master.masterData.getRowID(this.master.masterData.currentRow.get()));var s=e[this.idColumn];typeof s=="object"&&(s=s.value);var o=e;o.userdata||(o.userdata={}),t&&!Bind.isObservable(t.rows)&&(t.rows=Bind.observableArray()),o.userdata.parent=t;var u=o.userdata.recordState==Data.STATE.NEW||o.userdata.recordState==Data.STATE.EDIT;o.userdata.isModified=Bind.observable(u),u&&this.isModified.set(!0),o=new Row(this,o);for(i in this.defCols)this._bindValue(o,i,s);for(i in this.defCols)this._bindRule(o,i,s);return r||(t?t.rows.push(o):this.allDatas.push(o)),n||this.to(o),o},remove:function(e){e=e?e:this.currentRow.get();var t=e.row.userdata.parent,n=t?t.rows:this.allDatas,r=n.indexOf(e),i=n.get().length;if(r>=0&&r<i){var s=e===this.currentRow.get(),o=t?t.rows:this.datas,u=Bind.utils.arrayIndexOf(o.get(),e);n.splice(r,1);if(s){var a=this.getCount();i=o.get().length,a<=0?this.to(null):u<i?this.to(o.get()[u]):u>=i&&i>0?this.to(o.get()[u-1]):this.to(t)}}},_masterFilter:function(e,t){if(!this.master)return!0;var n=this.master.masterData;if(t){var r=t.ref(n.idColumn);if(Bind.isObservable(r))return e===r.get()}},_setTreeFilter:function(e){this.setFilter("_treeFilter_",e)},_aggregate:function(e,t,n){var r=this.allDatas.get(),i=0,s=0,o=null,u=null,a=n&&typeof n=="function",f=typeof n=="object"?n:undefined;for(var l=0;l<r.length;l++){var c=this.master?r[l].ref(this.master.relation).get():null;if(!a&&f===undefined||a&&n({source:this,row:r[l]})||f!==undefined&&this._masterFilter(c,f)){s++;if(t){var h=this.defCols[t],p=this.convert(r[l].ref(t).get(),h.type);i+=p,u=u===null?p:u<p?p:u,o=o===null?p:o>p?p:o}}}if("count"===e)return s;if("avg"===e)return i/s;if("sum"===e)return i;if("min"===e)return o;if("max"===e)return u},Count:function(e){return this._aggregate("count",null,e)},count:function(e){return this._aggregate("count",null,e)},Avg:function(e,t){return this._aggregate("avg",e,t)},avg:function(e,t){return this._aggregate("avg",e,t)},Sum:function(e,t){return this._aggregate("sum",e,t)},sum:function(e,t){return this._aggregate("sum",e,t)},Min:function(e,t){return this._aggregate("min",e,t)},min:function(e,t){return this._aggregate("min",e,t)},Max:function(e,t){return this._aggregate("max",e,t)},max:function(e,t){return this._aggregate("max",e,t)},_row2Json:function(e,t){var n={};for(var r in this.defCols)r!==this.idColumn&&(!t||t&&!this.isUICalculateCol(r))&&(n[r]=e.row[r]);return n.userdata=$.extend({},e.row.userdata),n.userdata.id=e.row[this.idColumn],delete n.userdata.parent,Bind.toJS(n)},_rows2Json:function(e,t){var n="",r="",i="";for(var s in this.defCols)if(s!==this.idColumn&&(!t||t&&!this.isUICalculateCol(s))){var o=this.defCols[s];n+=""!==n?","+s:s,r+=""!==r?","+o.type:o.type,i+=""!==i?","+o.define:o.define}return{"@type":"table",rows:e,userdata:{idColumnDefine:this.defCols[this.idColumn].define,idColumnName:this.idColumn,idColumnType:this.defCols[this.idColumn].type,model:this.dataModel,relationAlias:n,relationTypes:r,relations:i,updateMode:this.updateMode}}},toJson:function(e,t){var n=[];this.eachAll(function(r){var i=r.row,s=i.row.userdata.recordState;(!e||Data.STATE.EDIT==s||Data.STATE.NEW==s||Data.STATE.DELETE==s)&&n.push(this._row2Json(i,t))},this);var r=this.deleteDatas.get();if(r.length>0){var i=r.length;for(var s=0;s<i;s++)n.push(this._row2Json(r[s],t))}return this._rows2Json(n,t)}});return Data.Row=Row,Data.registerData=function(e,t,n){e instanceof Model&&(e[t]=n,e.registerComponent(t,n))},Data.unRegisterData=function(e,t){e instanceof Model&&(e.unRegisterComponent(t),delete e[t])},Data.$=function(e,t){return e instanceof Model?e.getComponent(t):null},Data.each=function(e,t){if(!e||!$.isFunction(t))return;for(var n in e){var r=e[n];if(r instanceof Data){var i={data:r,cancel:!1};t(i);if(i.cancel)return}}},Data.UUID=function(){return justep.UUID.createUUID()},Data.STATE={NEW:"new",DELETE:"delete",EDIT:"edit",NONE:"none"},Data.EVENT_CREATE="onCreate",Data.EVENT_CUSTOM_SORT="onCustomSort",Data.EVENT_VALUE_CHANGE="onValueChange",Data.EVENT_VALUE_CHANGED="onValueChanged",Data.EVENT_DATA_CHANGE="onDataChange",Data.EVENT_INDEX_CHANGED="onIndexChanged",Data.EVENT_INDEX_CHANGING="onIndexChanging",Data.EVENT_LOAD_SLAVEDATA="onLoadSlave",Data.EVENT_NEWDATA_ERROR="onNewError",Data.EVENT_NEWDATA_CREATEPARAM="onNewCreateParam",Data.EVENT_NEWDATA_BEFORE="onBeforeNew",Data.EVENT_NEWDATA="onCustomNew",Data.EVENT_NEWDATA_AFTER="onAfterNew",Data.EVENT_DELETEDATA_ERROR="onDeleteError",Data.EVENT_DELETEDATA_BEFORE="onBeforeDelete",Data.EVENT_DELETEDATA="onCustomDelete",Data.EVENT_DELETEDATA_AFTER="onAfterDelete",Data.EVENT_REFRESHDATA_ERROR="onRefreshError",Data.EVENT_REFRESHDATA_CREATEPARAM="onRefreshCreateParam",Data.EVENT_REFRESHDATA_BEFORE="onBeforeRefresh",Data.EVENT_REFRESHDATA="onCustomRefresh",Data.EVENT_REFRESHDATA_AFTER="onAfterRefresh",Data.EVENT_SAVEDATA_ERROR="onSaveError",Data.EVENT_SAVEDATA_CREATEPARAM="onSaveCreateParam",Data.EVENT_SAVEDATA_BEFORE="onBeforeSave",Data.EVENT_SAVEDATA="onCustomSave",Data.EVENT_SAVEDATA_AFTER="onAfterSave",Data.EVENT_SAVE_COMMIT="onSaveCommit",Data.LOAD_TREE_ROOT="___tree___root___",Data.NODE_KIND_LEAF="nkLeaf",Data.convert=function(e,t){var n=Data.createErrorValue(e);return-1<$.inArray(t,["Integer","Long"])&&typeof e=="string"?e=justep.String.toInt(e,n):-1<$.inArray(t,["Double","Float","Decimal"])&&typeof e=="string"?e=justep.String.toFloat(e,n):t=="Date"&&typeof e=="string"&&e?(e=justep.Date.fromString(e,"yyyy-MM-dd"),e||(e=n)):t=="DateTime"&&typeof e=="string"&&e&&(e=justep.Date.fromString(e,"yyyy-MM-ddThh:mm:ss.fff"),e||(e=n)),e},Data.createErrorValue=function(e){return{value:e,toString:function(){return NaN}}},Data.Rules=Rules,justep.Component.addOperations(Data,{save:{label:justep.Message.getMessage(justep.Message.JUSTEP231003),icon:"glyphicon glyphicon-floppy-disk",init:function(){var e=this,t=this.owner,n=function(){e.setEnable(!t.getReadonly()&&t.isChanged())};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_SAVE_COMMIT,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n)},method:function(e){return this.owner.saveData()}},"delete":{label:justep.Message.getMessage(justep.Message.JUSTEP231005),icon:"icon-minus",init:function(){var e=this,t=this.owner,n=function(){e.setEnable(!t.getReadonly()&&t.getCount()>0&&!!t.getCurrentRow())};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n)},argsDef:[{name:"rows",displayName:justep.Message.getMessage(justep.Message.JUSTEP231083)}],method:function(e){return this.owner.deleteData(e.rows)}},"new":{label:justep.Message.getMessage(justep.Message.JUSTEP231006),icon:"icon-plus",init:function(){var e=this,t=this.owner,n=function(){e.setEnable(!t.getReadonly())};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n)},argsDef:[{name:"defaultValues",displayName:justep.Message.getMessage(justep.Message.JUSTEP231084)},{name:"index",displayName:justep.Message.getMessage(justep.Message.JUSTEP231096)}],method:function(e){return this.owner.newData(e)}},newChild:{label:justep.Message.getMessage(justep.Message.JUSTEP231008),icon:"icon-plus",init:function(){var e=this,t=this.owner,n=function(){e.setEnable(t.isTree()&&!t.getReadonly()&&!!t.getCurrentRow())};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n)},argsDef:[{name:"defaultValues",displayName:justep.Message.getMessage(justep.Message.JUSTEP231084)}],method:function(e){return e.parent=this.owner.getCurrentRow(),this.owner.newData(e)}},newBrother:{label:justep.Message.getMessage(justep.Message.JUSTEP231009),icon:"icon-plus",init:function(){var e=this,t=this.owner,n=function(){e.setEnable(t.isTree()&&!t.getReadonly()&&!!t.getCurrentRow())};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n)},argsDef:[{name:"defaultValues",displayName:justep.Message.getMessage(justep.Message.JUSTEP231084)}],method:function(e){var t=this.owner.getCurrentRow();return t&&(e.parent=t.parent()),this.owner.newData(e)}},refresh:{label:justep.Message.getMessage(justep.Message.JUSTEP231007),icon:"icon-refresh",method:function(e){return this.owner.refreshData()}},firstRow:{label:justep.Message.getMessage(justep.Message.JUSTEP231086),icon:"icon-chevron-left",init:function(){var e=this,t=this.owner,n=function(){var n=t.getCount();e.setEnable(n>0)};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n)},method:function(){return this.owner.first()}},prevRow:{label:justep.Message.getMessage(justep.Message.JUSTEP231010),icon:"icon-chevron-left",init:function(){var e=this,t=this.owner,n=function(){var n=t.getCount();e.setEnable(n>0)};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n)},method:function(){return this.owner.pre()}},nextRow:{label:justep.Message.getMessage(justep.Message.JUSTEP231011),icon:"icon-chevron-right",init:function(){var e=this,t=this.owner,n=function(){var n=t.getCount();e.setEnable(n>0)};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n)},method:function(){return this.owner.next()}},lastRow:{label:justep.Message.getMessage(justep.Message.JUSTEP231087),icon:"icon-chevron-right",init:function(){var e=this,t=this.owner,n=function(){var n=t.getCount();e.setEnable(n>0)};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n)},method:function(){return this.owner.last()}},loadPage:{label:justep.Message.getMessage(justep.Message.JUSTEP231097),icon:"",argsDef:[{name:"pageIndex",displayName:justep.Message.getMessage(justep.Message.JUSTEP231061)}],method:function(e){var t=this.owner,n=isNaN(e.pagrIndex)||"number"!=typeof e.pagrIndex?1:e.pagrIndex;return t.loadPageData(n)}},firstPage:{label:justep.Message.getMessage(justep.Message.JUSTEP231064),icon:"",method:function(e){return this.owner.loadPageData(1)}},prevPage:{label:justep.Message.getMessage(justep.Message.JUSTEP231015),icon:"",method:function(e){var t=this.owner,n=t.getOffset()/t.limit-1;return t.loadPageData(n)}},nextPage:{label:justep.Message.getMessage(justep.Message.JUSTEP231014),icon:"",method:function(e){var t=this.owner,n=t.getOffset()/t.limit+1;return t.loadPageData(n)}},lastPage:{label:justep.Message.getMessage(justep.Message.JUSTEP231065),icon:"",method:function(e){var t=this.owner,n=t.getTotal()%t.limit,r=t.getTotal()/t.limit+(n===0?0:1);return t.loadPageData(r)}},loadNextPage:{label:justep.Message.getMessage(justep.Message.JUSTEP231012),icon:"",method:function(){return this.owner.loadNextPageData()}},loadAllPage:{label:justep.Message.getMessage(justep.Message.JUSTEP231013),icon:"",method:function(){return this.owner.loadAllPageData()}}}),Data}),define("$model/UI2/system/components/justep/model/model.config",["require"],function(e){return{properties:{},events:["onModelConstruct","onModelConstructing","onModelConstructDone","onLoad","onunLoad","onActive","onInactive"],binds:{}}}),define("$model/UI2/system/components/justep/model/model",["require","jquery","$UI/system/lib/justep","./model.config","$UI/system/resources/system.res"],function(e){var t=e("jquery"),n=e("$UI/system/lib/justep"),r=e.normalizeName("./model"),i=e("./model.config");e("$UI/system/resources/system.res");var s=n.ViewComponent.extend({buildTemplate:function(e){var t=new n.Message(n.Message.JUSTEP230073,r);throw n.Error.create(t)},getConfig:function(){return i},init:function(e,t){this.callParent(e,t),this.getModel().on(n.ModelBase.MODEL_CONSTRUCT_EVENT,this._fireEvent.bind(this,n.ModelBase.MODEL_CONSTRUCT_EVENT)),this.getModel().on(n.ModelBase.MODEL_CONSTRUCT_DONE_EVENT,this._fireEvent.bind(this,n.ModelBase.MODEL_CONSTRUCT_DONE_EVENT)),this.getModel().on(n.ModelBase.LOAD_EVENT,this._fireEvent.bind(this,n.ModelBase.LOAD_EVENT)),this.getModel().on(n.ModelBase.UNLOAD_EVENT,this._fireEvent.bind(this,n.ModelBase.UNLOAD_EVENT)),this.getModel().on(n.ModelBase.ACTIVE_EVENT,this._fireEvent.bind(this,n.ModelBase.ACTIVE_EVENT)),this.getModel().on(n.ModelBase.INACTIVE_EVENT,this._fireEvent.bind(this,n.ModelBase.INACTIVE_EVENT))},_fireEvent:function(e){this.fireEvent(e,{source:this})}});return n.Component.register(r,s),s}),define("$model/UI2/system/components/justep/window/window",["require","jquery","$UI/system/lib/justep","$UI/system/resources/system.res"],function(e){function c(e,t,n){var r=e.message||"",i=r.indexOf(t),s=r.indexOf(n);return i!=-1&&s!=-1&&s>i?r.substr(i+t.length,s-(i+t.length)):null}function h(e){return c(e,n.Error.CLIENT_ERROR_START,n.Error.CLIENT_ERROR_END)}function p(e){return c(e,n.Error.SERVER_ERROR_START,n.Error.SERVER_ERROR_END)}function d(){var e="__justepErrorDialog__",n=t("#"+e)[0];if(!n){var r="	<div class='modal' style='z-index:30000' id='"+e+"'>"+"		<div class='modal-dialog'>"+"			<div class='modal-content'>"+"				<div class='modal-header'>"+"					<h4>"+i+"</h4>"+"				</div>"+"				<div class='modal-body'>"+"					<div class='x-error-message'><span style='font-weight:bold'>"+s+"</span><span style='word-wrap: break-word;word-break: break-all;' class='x-error-message-body'/></div>"+"					<div class='x-error-code'><span style='font-weight:bold'>"+o+"</span><span class='x-error-code-body'/></div>"+"					<div class='x-error-reason'><span style='font-weight:bold'>"+u+"</span><span class='x-error-reason-body'/></div>"+"					<div><a href='javascript:void(0)' class='x-error-show-detail'>"+a+"</a></div>"+"					<div class='x-error-stack' style='word-wrap: break-word;'/>"+"				</div>"+"				<div class='modal-footer'>"+"					<button type='button' class='btn btn-default x-error-close'>"+l+"</button>"+"				</div>"+"			<div>"+"		</div>"+"	</div>",c=t(r);t("#applicationHost").append(c),c.find(".x-error-close").on("click",function(){c.hide()}),c.find(".x-error-show-detail").on("click",function(){var e=c.find(".x-error-show-detail");e.hasClass("x-error-show")?(e.removeClass("x-error-show"),e.text(a),c.find(".x-error-stack").hide()):(e.text(f),e.addClass("x-error-show"),c.find(".x-error-stack").show())}),this.domNode=c[0],this.$domNode=c}}var t=e("jquery"),n=e("$UI/system/lib/justep"),r=e.normalizeName("./window");e("$UI/system/resources/system.res");var i=(new n.Message(n.Message.JUSTEP230101)).getMessage(),s=(new n.Message(n.Message.JUSTEP230091)).getMessage(),o=(new n.Message(n.Message.JUSTEP230092)).getMessage(),u=(new n.Message(n.Message.JUSTEP230093)).getMessage(),a=(new n.Message(n.Message.JUSTEP230094)).getMessage(),f=(new n.Message(n.Message.JUSTEP230095)).getMessage(),l=(new n.Message(n.Message.JUSTEP230096)).getMessage();d.prototype.open=function(e){var t=e.server||e.client;this.$domNode.find(".x-error-message-body").text(t.message||""),t.code?(this.$domNode.find(".x-error-code").show(),this.$domNode.find(".x-error-code-body").text(t.code)):this.$domNode.find(".x-error-code").hide(),t.reason?(this.$domNode.find(".x-error-reason").show(),this.$domNode.find(".x-error-reason-body").text(t.code)):this.$domNode.find(".x-error-reason").hide(),this.$domNode.find(".x-error-show-detail").text(a).removeClass("x-error-show"),this.$domNode.find(".x-error-stack").text(t.stack||"").hide(),this.$domNode.show()},window.onerror=function(){var e=null;for(var t=0;t<arguments.length;t++)if(arguments[t]instanceof Error){e=arguments[t];break}var r={};if(e){var i=p(e);i?(r.server=JSON.parse(i),r.client={},r.client.message=(e.message||"").replace(n.Error.SERVER_ERROR_START,"").replace(n.Error.SERVER_ERROR_END,""),r.client.stack=(e.stack||"").replace(n.Error.SERVER_ERROR_START,"").replace(n.Error.SERVER_ERROR_END,"")):(i=h(e),i?(r.client=JSON.parse(i),r.client.stack||(r.client.stack=e.stack||""),r.client.stack=r.client.stack.replace(n.Error.CLIENT_ERROR_START,"").replace(n.Error.CLIENT_ERROR_END,"")):(r.client={},r.client.message=e.message,r.client.stack=e.stack))}else r.client={},r.client.message=arguments[0];return window.errorDialog||(window.errorDialog=new d),window.errorDialog.open(r),!1};var v=n.ViewComponent.extend({getConfig:function(){return{}},constructor:function(e){this.callParent(e)}});return n.Component.addOperations(v,{close:{label:n.Message.getMessage(n.Message.JUSTEP230096),icon:"icon-chevron-left",method:function(e){n.Portal.closeWindow()}}}),n.Component.register(r,v),v});